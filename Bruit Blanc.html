<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio - Générateur de Bruit & Calibration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #0f172a; 
            color: #f8fafc; 
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: ui-sans-serif, system-ui, sans-serif;
        }
        .preview-container-bg {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: -1;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .active-glow {
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
            border-color: #38bdf8 !important;
        }
        canvas {
            width: 100%;
            height: 120px;
            background: #020617;
            border-radius: 8px;
            border: 1px solid #1e293b;
        }
        input[type=range] {
            accent-color: #38bdf8;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="preview-container-bg"></div>

    <a href="Creator_Studio.html" class="fixed top-4 right-4 z-50 flex items-center space-x-2 bg-slate-800 hover:bg-red-900/40 border border-slate-700 hover:border-red-500 text-slate-300 hover:text-white px-6 py-3 rounded-xl transition-all shadow-lg group">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-1 transition-transform">
            <path d="m15 18-6-6 6-6"/>
        </svg>
        <span class="font-semibold text-lg text-sm sm:text-base">Quitter vers le Studio</span>
    </a>

    <main class="w-full max-w-2xl px-4 z-10">
        <div class="glass-panel p-6 sm:p-8 rounded-3xl space-y-6">
            
            <div class="text-center space-y-2">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-sky-400 to-blue-500 bg-clip-text text-transparent italic tracking-tight uppercase">
                    Calibration Audio
                </h1>
                <p class="text-slate-400 text-sm">Générateur pour configurer vos filtres (OBS, VST, Audacity)</p>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between text-xs font-mono text-slate-500 uppercase tracking-widest px-1">
                    <span>Analyseur de Spectre</span>
                    <span id="db-value">-∞ dB</span>
                </div>
                <canvas id="visualizer"></canvas>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button onclick="setMode('white')" id="btn-white" class="mode-btn p-3 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-all text-sm font-medium">
                    Bruit Blanc
                </button>
                <button onclick="setMode('pink')" id="btn-pink" class="mode-btn p-3 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-all text-sm font-medium">
                    Bruit Rose
                </button>
                <button onclick="setMode('brown')" id="btn-brown" class="mode-btn p-3 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-all text-sm font-medium">
                    Bruit Brun
                </button>
                <button onclick="setMode('sine')" id="btn-sine" class="mode-btn p-3 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 transition-all text-sm font-medium">
                    Sinus (1kHz)
                </button>
            </div>

            <div class="space-y-4 bg-slate-900/50 p-5 rounded-2xl border border-slate-800/50">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Volume (Gain)</label>
                        <span id="vol-label" class="text-sky-400 font-mono text-sm">15%</span>
                    </div>
                    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.15" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>

                <div id="freq-container" class="space-y-2 opacity-30 transition-opacity">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Fréquence de test</label>
                        <span id="freq-label" class="text-sky-400 font-mono text-sm">1000 Hz</span>
                    </div>
                    <input type="range" id="frequency" min="20" max="20000" step="1" value="1000" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" disabled>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button id="master-toggle" class="w-full py-4 rounded-2xl bg-sky-500 hover:bg-sky-400 text-slate-900 font-bold text-xl shadow-lg shadow-sky-500/20 transition-all flex items-center justify-center space-x-3">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="stop-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                    <span id="btn-text">Démarrer le signal</span>
                </button>

                <button onclick="toggleHelp()" class="text-xs text-slate-500 hover:text-sky-400 transition-colors underline decoration-slate-700 underline-offset-4">
                    Comment envoyer ce son dans mon entrée micro ?
                </button>
            </div>
        </div>
    </main>

    <div id="help-modal" class="modal" onclick="if(event.target === this) toggleHelp()">
        <div class="glass-panel max-w-md w-full p-8 rounded-3xl space-y-6 border-sky-500/30">
            <h2 class="text-xl font-bold text-sky-400 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Routage Audio Virtuel
            </h2>
            <div class="text-sm text-slate-300 space-y-4 leading-relaxed">
                <p>Pour que ce générateur soit détecté comme un "Micro" dans OBS ou Discord, vous avez besoin d'un <strong>Câble Audio Virtuel</strong>.</p>
                <ol class="list-decimal list-inside space-y-3 text-slate-400">
                    <li>Installez un logiciel gratuit comme <span class="text-white font-medium">VB-Audio Cable</span>.</li>
                    <li>Réglez la sortie audio de votre système sur <span class="text-sky-400 italic">"CABLE Input"</span>.</li>
                    <li>Dans OBS, choisissez <span class="text-sky-400 italic">"CABLE Output"</span> comme source Micro.</li>
                </ol>
            </div>
            <button onclick="toggleHelp()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 rounded-xl font-semibold transition-all">J'ai compris</button>
        </div>
    </div>

    <script>
        let audioCtx;
        let sourceNode;
        let gainNode;
        let analyser;
        let isPlaying = false;
        let currentMode = 'white';
        let animationId;

        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const masterToggle = document.getElementById('master-toggle');
        const volSlider = document.getElementById('volume');
        const volLabel = document.getElementById('vol-label');
        const freqSlider = document.getElementById('frequency');
        const freqLabel = document.getElementById('freq-label');
        const freqContainer = document.getElementById('freq-container');
        const dbLabel = document.getElementById('db-value');

        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioCtx.createGain();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512; // Plus petit pour une meilleure réactivité visuelle
                gainNode.connect(analyser);
                analyser.connect(audioCtx.destination);
                gainNode.gain.value = volSlider.value;
            }
        }

        function createNoiseBuffer(type) {
            const bufferSize = 2 * audioCtx.sampleRate;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = buffer.getChannelData(0);
            let lastOut = 0;

            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                if (type === 'white') {
                    output[i] = white;
                } else if (type === 'pink') {
                    output[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = output[i];
                    output[i] *= 3.5;
                } else if (type === 'brown') {
                    output[i] = (lastOut + (0.02 * white)) / 1.01;
                    lastOut = output[i];
                    output[i] *= 8.0;
                }
            }
            return buffer;
        }

        function startSignal() {
            if (sourceNode) {
                try { sourceNode.stop(); } catch(e) {}
            }
            
            if (currentMode === 'sine') {
                sourceNode = audioCtx.createOscillator();
                sourceNode.type = 'sine';
                sourceNode.frequency.setValueAtTime(freqSlider.value, audioCtx.currentTime);
            } else {
                sourceNode = audioCtx.createBufferSource();
                sourceNode.buffer = createNoiseBuffer(currentMode);
                sourceNode.loop = true;
            }
            sourceNode.connect(gainNode);
            sourceNode.start();
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active-glow', 'bg-sky-900/20'));
            const activeBtn = document.getElementById(`btn-${mode}`);
            if(activeBtn) activeBtn.classList.add('active-glow', 'bg-sky-900/20');

            if (mode === 'sine') {
                freqContainer.classList.remove('opacity-30');
                freqSlider.disabled = false;
            } else {
                freqContainer.classList.add('opacity-30');
                freqSlider.disabled = true;
            }
            if (isPlaying) startSignal();
        }

        masterToggle.addEventListener('click', async () => {
            initAudio();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            if (isPlaying) {
                if (sourceNode) sourceNode.stop();
                cancelAnimationFrame(animationId);
                document.getElementById('play-icon').classList.remove('hidden');
                document.getElementById('stop-icon').classList.add('hidden');
                document.getElementById('btn-text').innerText = "Démarrer le signal";
                masterToggle.classList.replace('bg-red-500', 'bg-sky-500');
                masterToggle.classList.replace('hover:bg-red-400', 'hover:bg-sky-400');
                dbLabel.innerText = "-∞ dB";
                
                // Clear canvas
                ctx.fillStyle = '#020617';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                startSignal();
                document.getElementById('play-icon').classList.add('hidden');
                document.getElementById('stop-icon').classList.remove('hidden');
                document.getElementById('btn-text').innerText = "Arrêter le signal";
                masterToggle.classList.replace('bg-sky-500', 'bg-red-500');
                masterToggle.classList.replace('hover:bg-sky-400', 'hover:bg-red-400');
                draw();
            }
            isPlaying = !isPlaying;
        });

        volSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (gainNode) gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.05);
            volLabel.innerText = Math.round(val * 100) + "%";
        });

        freqSlider.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            if (sourceNode && currentMode === 'sine') {
                sourceNode.frequency.setTargetAtTime(val, audioCtx.currentTime, 0.05);
            }
            freqLabel.innerText = val + " Hz";
        });

        function draw() {
            if (!isPlaying) return;
            animationId = requestAnimationFrame(draw);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Mise à jour dB
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let avg = sum / dataArray.length;
            let db = Math.round((avg / 255) * 100) - 100;
            dbLabel.innerText = `${db} dB`;

            // Rendu Canvas
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                const hue = (i / bufferLength) * 120 + 190; // Bleu -> Cyan
                ctx.fillStyle = `hsla(${hue}, 80%, 50%, 0.9)`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        window.onload = () => {
            setMode('white');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        };

        window.onresize = () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        };
    </script>
</body>
</html>
